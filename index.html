<!DOCTYPE application/html>
<html>

<head>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>
  <script>
    AFRAME.registerComponent('unlit', {
      init() {
          this.el.addEventListener("model-loaded", () => this.apply());
          if (this.el.getObject3D("mesh")) this.apply();
      },

      apply() {
        const mesh = this.el.getObject3D("mesh");
        if (!mesh) return;

        mesh.traverse(node => {
          if (node.isMesh && node.material) {
            // Se o material tiver textura, mantemos ela
            const originalMap = node.material.map || null;
            const originalColor = node.material.color || new THREE.Color(0xffffff);
            const originalOpacity = node.material.opacity || 1;
            const transparent = node.material.transparent || false;

            node.material = new THREE.MeshBasicMaterial({
                map: originalMap,
                color: originalColor,
                opacity: originalOpacity,
                transparent: transparent
            });
          }
        });
      }
    });
  </script>
</head>

<body style="margin : 0px; overflow: hidden;">
  <a-scene background="color: gray" vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-assets>
      <img id="painel20" src="assets/20.png">
      <img id="painel50" src="assets/50.png">
      <img id="painel100" src="assets/100.png">
      <gltf-model id="maga-model" src="assets/3D models/maga/maga.gltf"></gltf-model>
    </a-assets>

    <a-marker preset='custom' type='pattern' url='assets/markers/pattern-20.patt' id="marker20">
      <a-plane src="#painel20" height="1" width="1" rotation="0 0 0" position="0 1 0"></a-plane>
    </a-marker>
    <a-marker preset='custom' type='pattern' url='assets/markers/pattern-50.patt' id="marker50">
      <a-plane src="#painel50" height="1" width="1" rotation="0 0 0" position="0 1 0"></a-plane>
    </a-marker>
    <a-marker preset='custom' type='pattern' url='assets/markers/pattern-100.patt' id="marker100">
      <a-plane src="#painel100" height="1" width="1" rotation="0 0 0" position="0 1 0"></a-plane>
    </a-marker>

    <a-entity camera position="0 .1 .4"></a-entity>
  </a-scene>

  <script>
    let alunoDinheiro = 0;
    let personagemSelecionado = undefined;

    // Defina os valores numéricos associados a cada marker
    const markerValues = {
      marker20: 20,
      marker50: 50,
      marker100: 100
    };

    function setQuantia(quantia) {
      alunoDinheiro = quantia;
    }

    function setPesonagem(nome) {
      personagemSelecionado = nome;
    }

    // Função para lidar com a detecção de markers
    document.querySelectorAll('a-marker').forEach(marker => {
      var currentChar;
      marker.addEventListener('markerFound', (event) => {

        if (event.target.id !== marker.id) return;

        const newChar = novoPersonagem();
        currentChar = newChar;
        marker.appendChild(newChar);
        const value = markerValues[marker.id];

        if (alunoDinheiro < value) {
          setTimeout(() => newChar.setAttribute('animation-mixer', 'clip: Dyning; loop: once; clampWhenFinished:true; crossFadeDuration:1'), 1500)
        } else if (alunoDinheiro === value) {
          setTimeout(() => newChar.setAttribute('animation-mixer', 'clip: Dancing; loop: repeat; crossFadeDuration:1'), 1500)
        } else {
          setTimeout(() => newChar.setAttribute('animation-mixer', 'clip: Flair; loop: repeat; crossFadeDuration:0.1'), 1500);
        }
      });

      marker.addEventListener('markerLost', (event) => {
        if (event.target.id !== marker.id) return;
        marker.removeChild(currentChar);
      });
    });


    function novoPersonagem(nome) {
      if (nome == undefined) {
        nome = "maga";
      }

      const newChar = document.createElement('a-entity');
      newChar.setAttribute('gltf-model', `assets/3D models/${nome}/${nome}.gltf`);
      newChar.setAttribute('unlit');
      newChar.setAttribute('position', '1 0 0');
      newChar.setAttribute('scale', '0.1 0.1 0.1');
      newChar.setAttribute('rotation', '0 0 0');
      return newChar;
    }
  </script>
</body>

</html>