<!DOCTYPE application/html>
<html>

<head>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>
  <script>
    AFRAME.registerComponent('unlit', {
      init() {
          this.el.addEventListener("model-loaded", () => this.apply());
          if (this.el.getObject3D("mesh")) this.apply();
      },

      apply() {
        const mesh = this.el.getObject3D("mesh");
        if (!mesh) return;

        mesh.traverse(node => {
          if (node.isMesh && node.material) {
            // Se o material tiver textura, mantemos ela
            const originalMap = node.material.map || null;
            const originalColor = node.material.color || new THREE.Color(0xffffff);
            const originalOpacity = node.material.opacity || 1;
            const transparent = node.material.transparent || false;

            node.material = new THREE.MeshBasicMaterial({
                map: originalMap,
                color: originalColor,
                opacity: originalOpacity,
                transparent: transparent
            });
          }
        });
      }
    });
  </script>
</head>

<body style="margin : 0px; overflow: hidden;">
  <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-assets>
      <img id="marker20" src="assets/markers/20.png">
      <img id="marker50" src="assets/markers/50.png">
      <img id="marker100" src="assets/markers/100.png">
      <gltf-model id="maga-model" src="assets/3D models/maga/maga.gltf"></gltf-model>
    </a-assets>

    <a-marker preset='custom' type='pattern' url='assets/markers/pattern-20.patt' id="amarker20"></a-marker>
    <a-marker preset='custom' type='pattern' url='assets/markers/pattern-50.patt' id="amarker50"></a-marker>
    <a-marker preset='custom' type='pattern' url='assets/markers/pattern-100.patt' id="amarker100"></a-marker>

    <a-entity camera></a-entity>
    <a-entity light="type: ambient"></a-entity>
  </a-scene>

  <script>
    let alunoDinheiro = 200;
    let personagemSelecionado = undefined;

    // Defina os valores numéricos associados a cada marker
    const markerValues = {
      amarker20: 20,
      amarker50: 50,
      amarker100: 100
    };

    function setQuantia(quantia) {
      alunoDinheiro = quantia;
    }

    function setPesonagem(nome) {
      personagemSelecionado = nome;
    }

    // Função para lidar com a detecção de markers
    document.querySelectorAll('a-marker').forEach(marker => {
      var currentChar;

      const plane = document.createElement('a-plane');
      plane.setAttribute('src', `#marker${marker.id.replace('amarker', '')}`);
      plane.setAttribute('height', '1');
      plane.setAttribute('width', '1');
      plane.setAttribute('rotation', '-90 0 0');
      plane.setAttribute('position', '0 -.1 0');
      marker.appendChild(plane);

      marker.addEventListener('markerFound', (event) => {

        if (event.target.id !== marker.id) return;

        const newChar = novoPersonagem();
        currentChar = newChar;
        marker.appendChild(newChar);
        const value = markerValues[marker.id];

        if (alunoDinheiro < value) {
          newChar.setAttribute('animation-mixer', 'clip: Dyning; loop: once; clampWhenFinished:true; crossFadeDuration:1')
        } else if (alunoDinheiro === value) {
          newChar.setAttribute('animation-mixer', 'clip: Dancing; loop: repeat; crossFadeDuration:1')
        } else {
          newChar.setAttribute('animation-mixer', 'clip: Flair; loop: repeat; crossFadeDuration:0.1')
        }
      });

      marker.addEventListener('markerLost', (event) => {
        if (event.target.id !== marker.id) return;
        marker.removeChild(currentChar);
      });
    });


    function novoPersonagem(nome) {
      if (nome == undefined) {
        nome = "maga";
      }

      const newChar = document.createElement('a-entity');
      newChar.setAttribute('gltf-model', `#maga-model`);
      newChar.setAttribute('unlit', '');
      newChar.setAttribute('position', '0 0 0');
      newChar.setAttribute('scale', '1 1 1');
      newChar.setAttribute('rotation', '0 0 0');
      return newChar;
    }
  </script>
</body>

</html>